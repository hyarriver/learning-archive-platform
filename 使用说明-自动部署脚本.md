# 自动部署脚本使用说明

## 脚本文件
- **文件名**: `自动部署脚本.sh`
- **功能**: 一键完成所有部署步骤
- **适用系统**: Ubuntu/Debian/CentOS/RHEL

## 使用方法

### 1. 上传脚本到服务器

将 `自动部署脚本.sh` 上传到服务器的项目目录，或直接在服务器上创建：

```bash
# 如果脚本在项目目录中
cd /opt/Learning\ Archive\ Platform
chmod +x 自动部署脚本.sh
```

### 2. 运行脚本

```bash
# 使用 root 用户运行
sudo ./自动部署脚本.sh
# 或
su - root -c "./自动部署脚本.sh"
```

### 3. 脚本会自动完成以下步骤

1. ✅ **检查 Python 环境**
   - 检查 Python 3 是否安装
   - 检查 python3-venv 是否安装
   - 如未安装，自动安装

2. ✅ **检查项目目录**
   - 验证项目目录是否存在
   - 验证后端目录是否存在

3. ✅ **创建虚拟环境**
   - 删除旧的虚拟环境（如果存在）
   - 创建新的 Python 虚拟环境
   - 验证虚拟环境是否有效

4. ✅ **安装依赖**
   - 激活虚拟环境
   - 升级 pip
   - 安装所有 Python 依赖包

5. ✅ **配置环境变量**
   - 复制 .env.example 到 .env
   - 自动生成随机 SECRET_KEY 和 JWT_SECRET_KEY
   - 设置 PORT=3000, DEBUG=False, APP_ENV=production

6. ✅ **初始化数据库**
   - 创建数据库表结构
   - 创建必要的索引

7. ✅ **创建管理员用户**（可选）
   - 检查数据库中是否已有用户
   - 如无用户，提示输入用户名和密码创建

8. ✅ **创建 systemd 服务**
   - 创建 /etc/systemd/system/archive-platform.service
   - 配置服务自动启动和重启

9. ✅ **配置防火墙**
   - 自动配置 UFW 或 Firewalld
   - 开放 3000 端口

10. ✅ **启动服务**
    - 启动 systemd 服务
    - 验证服务是否正常运行

11. ✅ **验证部署**
    - 检查服务状态
    - 测试健康检查端点

## 交互提示

脚本运行过程中会询问：

1. **覆盖现有 .env 文件**
   ```
   如果 .env 已存在，是否覆盖？(y/n)
   ```

2. **创建管理员用户**
   ```
   是否现在创建管理员用户？(y/n)
   请输入管理员用户名（默认: admin）:
   请输入管理员密码:
   确认密码:
   ```

3. **覆盖现有服务文件**
   ```
   服务文件已存在，是否覆盖？(y/n)
   ```

## 自动化特性

- ✅ 自动检测系统类型（Ubuntu/Debian/CentOS）
- ✅ 自动安装缺失的依赖
- ✅ 自动生成安全密钥
- ✅ 自动配置防火墙
- ✅ 自动启动服务
- ✅ 详细的错误提示和日志

## 常见问题

### 1. 脚本执行权限

```bash
# 如果提示权限不足，添加执行权限
chmod +x 自动部署脚本.sh
```

### 2. 虚拟环境创建失败

脚本会自动尝试安装 `python3-venv`，如果仍然失败，请手动安装：

```bash
# Ubuntu/Debian
apt install python3.12-venv

# CentOS/RHEL
yum install python3-venv
```

### 3. 服务启动失败

查看详细错误信息：

```bash
# 查看服务状态
systemctl status archive-platform

# 查看日志
journalctl -u archive-platform -n 50

# 手动测试
cd /opt/Learning\ Archive\ Platform/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 3000
```

### 4. 端口被占用

```bash
# 检查端口占用
netstat -tulpn | grep 3000

# 修改 .env 文件中的 PORT
nano /opt/Learning\ Archive\ Platform/backend/.env
# 修改 PORT=其他端口号
```

### 5. 防火墙配置

如果防火墙未自动配置，手动配置：

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 3000/tcp
sudo ufw reload

# CentOS/RHEL (Firewalld)
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

## 部署后操作

### 查看服务状态
```bash
systemctl status archive-platform
```

### 查看实时日志
```bash
journalctl -u archive-platform -f
```

### 重启服务
```bash
systemctl restart archive-platform
```

### 创建更多用户
```bash
cd /opt/Learning\ Archive\ Platform/backend
source venv/bin/activate
python scripts/create_user.py <用户名> <密码>
```

### 手动触发采集
```bash
# 通过 API（需要先登录获取 token）
curl -X POST http://112.124.2.164:3000/api/collection/trigger \
  -H "Authorization: Bearer <your_token>"
```

## 访问地址

部署成功后，可以通过以下地址访问：

- **前端页面**: http://112.124.2.164:3000/
- **API 文档**: http://112.124.2.164:3000/docs
- **健康检查**: http://112.124.2.164:3000/health

## 注意事项

1. ⚠️ **必须使用 root 用户运行**脚本
2. ⚠️ **确保项目文件已上传**到 `/opt/Learning Archive Platform`
3. ⚠️ **确保网络连接正常**，以便下载依赖包
4. ⚠️ **首次运行可能需要较长时间**（安装依赖）
5. ⚠️ **脚本会询问是否覆盖现有配置**，请谨慎选择

## 安全建议

1. 部署后修改默认密码
2. 定期更新依赖包
3. 配置 HTTPS（推荐使用 Let's Encrypt）
4. 限制防火墙规则，只允许必要的 IP 访问
5. 定期备份数据库和文件

---

**脚本已就绪，可以直接使用！**
