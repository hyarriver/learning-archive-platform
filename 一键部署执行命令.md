# 一键部署执行命令

## 快速使用

### 1. 上传脚本到服务器

将 `智能自动部署脚本.sh` 上传到服务器项目目录。

### 2. 在服务器上执行

```bash
# SSH 登录服务器
ssh root@112.124.2.164

# 进入项目目录
cd /opt/Learning\ Archive\ Platform

# 给脚本添加执行权限
chmod +x 智能自动部署脚本.sh

# 运行脚本（自动重试和修复）
./智能自动部署脚本.sh
```

## 脚本特性

✅ **自动检测和修复错误**
- 自动安装缺失的依赖
- 自动修复虚拟环境问题
- 自动修复配置问题
- 自动修复数据库问题

✅ **重试机制**
- 自动重试失败的步骤（最多3次）
- 整个部署流程失败后自动重试（最多3次）

✅ **详细日志**
- 彩色输出，清晰显示进度
- 错误时显示详细错误信息
- 自动查看服务日志

## 脚本会自动处理

1. ✅ 检查并安装 Python 3
2. ✅ 检查并安装 python3-venv
3. ✅ 创建/修复虚拟环境（失败自动重试）
4. ✅ 安装依赖（失败自动重试）
5. ✅ 配置环境变量（自动生成密钥）
6. ✅ 初始化数据库（失败自动重试）
7. ✅ 创建 systemd 服务
8. ✅ 配置防火墙
9. ✅ 启动服务并验证

## 执行示例

```bash
root@server:/opt/Learning Archive Platform# ./智能自动部署脚本.sh
==========================================
学习资料聚合平台 - 智能自动部署脚本
==========================================

[信息] ========== 部署尝试 1/3 ==========
[信息] 开始部署流程...
[信息] 检查 Python 环境...
[成功] Python 环境检查通过
[信息] 修复虚拟环境...
[信息] 执行命令 (尝试 1/3): python3 -m venv venv
[成功] 命令执行成功
[成功] 虚拟环境创建成功
[信息] 安装/修复 Python 依赖...
[成功] 依赖安装完成
...
[成功] 部署成功！
```

## 如果脚本执行失败

脚本会自动：
1. 尝试修复常见错误
2. 自动重试失败的步骤
3. 如果整个部署失败，会自动重新尝试整个流程（最多3次）

如果所有重试都失败，脚本会：
- 显示详细的错误信息
- 显示日志查看命令
- 显示手动测试命令

## 手动检查问题

如果自动修复失败，可以手动检查：

```bash
# 1. 查看服务日志
journalctl -u archive-platform -n 50

# 2. 手动测试服务
cd /opt/Learning\ Archive\ Platform/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 3000

# 3. 检查端口占用
netstat -tulpn | grep 3000

# 4. 检查文件权限
ls -la /opt/Learning\ Archive\ Platform/backend/

# 5. 检查虚拟环境
ls -la /opt/Learning\ Archive\ Platform/backend/venv/bin/
```

## 部署成功后的操作

```bash
# 1. 创建管理员用户（如果需要）
cd /opt/Learning\ Archive\ Platform/backend
source venv/bin/activate
python scripts/create_user.py admin your_password

# 2. 查看服务状态
systemctl status archive-platform

# 3. 访问服务
# 前端: http://112.124.2.164:3000/
# API文档: http://112.124.2.164:3000/docs
```

---

**脚本已准备就绪，可以直接运行！**
