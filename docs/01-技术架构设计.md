# 技术架构设计文档

## 1. 整体架构

### 1.1 架构模式
```
┌─────────────┐
│   前端 Web   │  (响应式，PC/移动端)
└──────┬──────┘
       │ HTTP/HTTPS
┌──────▼──────────────────────────┐
│        后端 API 服务             │
│  ┌────────────────────────────┐ │
│  │  用户认证与权限模块          │ │
│  │  内容采集调度模块            │ │
│  │  文件管理模块               │ │
│  │  API 接口层                │ │
│  └────────────────────────────┘ │
└──────┬──────────────────────────┘
       │
┌──────▼──────────────────────────┐
│     数据与存储层                  │
│  ┌──────────┐  ┌──────────────┐ │
│  │ SQLite   │  │  文件系统    │ │
│  │ 数据库    │  │  Markdown    │ │
│  └──────────┘  └──────────────┘ │
└──────────────────────────────────┘
       │
┌──────▼──────────────────────────┐
│     定时任务层                    │
│  ┌────────────────────────────┐ │
│  │  爬虫采集任务 (0点执行)     │ │
│  │  内容转换任务               │ │
│  │  版本管理任务               │ │
│  └────────────────────────────┘ │
└──────────────────────────────────┘
```

### 1.2 技术栈选择

#### 后端
- **框架**: FastAPI (轻量、高性能、自动文档)
- **数据库**: SQLite (轻量、无配置)
- **ORM**: SQLAlchemy (可选) 或原生 SQL
- **任务调度**: APScheduler (Python内调度) 或 Cron
- **爬虫**: 
  - requests + BeautifulSoup (简单网页)
  - selenium/playwright (动态内容)
  - youtube-dl/yt-dlp (视频字幕)
- **Markdown处理**: 
  - markdown + html2text
  - pandoc (高质量转换)

#### 前端
- **方案A (简单)**: HTML + CSS + Vanilla JS (直接快速)
- **方案B (现代)**: React/Vue + Vite (如需组件化)

#### 存储
- **文件系统**: 按来源网站/主题组织目录
- **数据库**: 存储元数据（用户、采集记录、文件索引）

---

## 2. 模块划分

### 2.1 后端模块结构

```
backend/
├── app/
│   ├── __init__.py
│   ├── main.py              # FastAPI应用入口
│   ├── config.py            # 配置管理
│   ├── database.py          # 数据库连接与模型
│   │
│   ├── api/                 # API路由
│   │   ├── auth.py          # 认证相关
│   │   ├── files.py         # 文件管理
│   │   ├── collection.py    # 采集配置
│   │   └── users.py         # 用户管理
│   │
│   ├── models/              # 数据模型
│   │   ├── user.py
│   │   ├── collection.py
│   │   ├── file.py
│   │   └── version.py
│   │
│   ├── crawler/             # 爬虫模块
│   │   ├── __init__.py
│   │   ├── base.py          # 基础爬虫类
│   │   ├── webpage.py       # 网页爬虫
│   │   ├── video.py         # 视频字幕爬虫
│   │   └── parser.py        # 内容解析器
│   │
│   ├── converter/           # 转换模块
│   │   ├── __init__.py
│   │   ├── to_markdown.py   # 转Markdown
│   │   ├── toc_generator.py # 目录生成
│   │   └── tag_extractor.py # 标签提取
│   │
│   ├── storage/             # 存储模块
│   │   ├── __init__.py
│   │   ├── file_manager.py  # 文件管理
│   │   └── version_manager.py # 版本管理
│   │
│   ├── scheduler/           # 任务调度
│   │   ├── __init__.py
│   │   └── tasks.py         # 定时任务定义
│   │
│   └── utils/               # 工具函数
│       ├── auth.py          # 认证工具
│       ├── logger.py        # 日志
│       └── helpers.py       # 通用工具
│
├── tests/                   # 测试
├── scripts/                 # 脚本工具
│   └── init_db.py          # 初始化数据库
│
└── requirements.txt         # 依赖管理
```

### 2.2 前端模块结构（方案A：简单版）

```
frontend/
├── index.html              # 主页面
├── css/
│   ├── main.css
│   └── mobile.css          # 移动端适配
├── js/
│   ├── api.js              # API调用封装
│   ├── auth.js             # 登录逻辑
│   ├── file-list.js        # 文件列表
│   └── upload.js           # 上传功能
└── assets/                 # 静态资源
```

---

## 3. 数据模型设计

### 3.1 数据库表结构

#### users (用户表)
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);
```

#### collection_sources (采集源配置)
```sql
CREATE TABLE collection_sources (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,              -- 来源名称
    url_pattern TEXT NOT NULL,       -- URL模式/正则
    source_type TEXT NOT NULL,       -- 'webpage' / 'video'
    crawler_config TEXT,             -- JSON配置
    enabled BOOLEAN DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### files (文件索引)
```sql
CREATE TABLE files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    source_id INTEGER,               -- 关联采集源
    file_path TEXT NOT NULL,         -- 相对路径
    file_hash TEXT,                  -- 文件哈希（去重）
    tags TEXT,                       -- JSON数组
    summary TEXT,                    -- 摘要
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (source_id) REFERENCES collection_sources(id)
);
```

#### collection_logs (采集日志)
```sql
CREATE TABLE collection_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    source_id INTEGER,
    url TEXT NOT NULL,
    status TEXT NOT NULL,            -- 'success' / 'failed' / 'skipped'
    error_message TEXT,
    file_id INTEGER,                 -- 成功时关联文件
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (source_id) REFERENCES collection_sources(id),
    FOREIGN KEY (file_id) REFERENCES files(id)
);
```

#### file_versions (文件版本)
```sql
CREATE TABLE file_versions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_id INTEGER NOT NULL,
    version_number INTEGER NOT NULL,
    file_path TEXT NOT NULL,
    content_hash TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (file_id) REFERENCES files(id),
    UNIQUE(file_id, version_number)
);
```

### 3.2 文件系统结构

```
data/
├── collections/              # 采集内容
│   ├── {source_name}/       # 按来源分组
│   │   ├── {date}/          # 按日期
│   │   │   ├── {filename}.md
│   │   │   └── versions/    # 版本历史
│   │   │       └── v{version}.md
│   │   └── ...
│   └── ...
│
├── uploads/                 # 用户上传
│   ├── {user_id}/
│   │   └── {filename}
│   └── ...
│
└── metadata/                # 元数据缓存（可选）
    └── ...
```

---

## 4. 核心流程设计

### 4.1 采集流程

```
定时任务触发 (0点)
    ↓
遍历 enabled 的采集源
    ↓
对每个 URL/模式执行爬虫
    ↓
内容解析与清理
    ↓
转换为 Markdown
    ↓
生成 TOC、标签、摘要
    ↓
计算文件哈希（去重判断）
    ↓
保存文件 + 更新数据库
    ↓
记录采集日志
```

### 4.2 版本管理流程

```
采集新内容
    ↓
检查文件是否存在（哈希/路径）
    ↓
如存在且内容不同
    ↓
创建新版本（递增version_number）
    ↓
保留历史版本在 versions/ 目录
    ↓
更新文件索引指向最新版本
```

### 4.3 用户访问流程

```
用户登录
    ↓
验证JWT Token
    ↓
获取文件列表（按来源/标签筛选）
    ↓
用户选择文件
    ↓
读取Markdown内容
    ↓
渲染显示 / 提供下载
```

---

## 5. 关键技术点

### 5.1 爬虫稳定性
- **重试机制**: 失败后重试3次，指数退避
- **请求头模拟**: 避免被反爬
- **频率限制**: 请求间隔1-2秒
- **错误隔离**: 单URL失败不影响整体

### 5.2 Markdown转换质量
- **HTML清理**: 去除广告、导航等无关内容
- **代码块保留**: 保持语法高亮信息
- **表格转换**: 确保表格结构完整
- **图片处理**: 可选下载图片或保留链接

### 5.3 性能优化
- **异步采集**: 多源并行采集
- **增量采集**: 基于更新时间/哈希判断
- **缓存策略**: 元数据缓存减少数据库查询
- **分页加载**: 文件列表分页

### 5.4 安全考虑
- **密码加密**: bcrypt
- **JWT Token**: 无状态认证
- **文件路径验证**: 防止路径遍历攻击
- **访问控制**: 仅登录用户可访问

---

## 6. 部署方案

### 6.1 本地/云服务器部署

```
服务器环境:
- Python 3.9+
- SQLite (无需额外配置)
- 40GB存储空间

部署步骤:
1. 克隆代码
2. 安装依赖: pip install -r requirements.txt
3. 初始化数据库: python scripts/init_db.py
4. 配置环境变量
5. 启动服务: uvicorn app.main:app --host 0.0.0.0 --port 8000
6. 配置Nginx反向代理（可选）
7. 配置定时任务（Cron或APScheduler）
```

### 6.2 Docker部署（可选）

```dockerfile
# Dockerfile示例
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## 7. 监控与日志

### 7.1 日志策略
- **采集日志**: 记录每个URL的采集状态
- **错误日志**: 记录异常堆栈
- **访问日志**: API访问记录
- **日志轮转**: 按日期/大小分割

### 7.2 监控指标
- 采集成功率
- 存储使用率
- API响应时间
- 用户活跃度

---

## 8. 扩展性考虑

### 8.1 未来可扩展
- 支持更多内容源（RSS、API）
- AI摘要生成（可选）
- 全文搜索（Elasticsearch/SQLite FTS）
- 文件格式转换（PDF导出）

### 8.2 保持精简
- 不引入复杂中间件
- 数据库保持SQLite（<50用户足够）
- 前端保持轻量
