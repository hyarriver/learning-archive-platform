# éƒ¨ç½²æŒ‡å—

## ğŸ“¦ éƒ¨ç½²æ–¹å¼

æœ¬é¡¹ç›®æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©ã€‚

## 1. Dockeréƒ¨ç½²ï¼ˆæ¨èï¼‰

### 1.1 ä½¿ç”¨Docker Composeï¼ˆæœ€ç®€å•ï¼‰

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd "Learning Archive Platform"

# é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down
```

### 1.2 ä½¿ç”¨Docker

```bash
# æ„å»ºé•œåƒ
docker build -t learning-archive-platform .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name learning-archive \
  -p 8000:8000 \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/logs:/app/logs \
  -e SECRET_KEY=your-secret-key \
  learning-archive-platform

# æŸ¥çœ‹æ—¥å¿—
docker logs -f learning-archive
```

## 2. æœ¬åœ°éƒ¨ç½²

### 2.1 ç¯å¢ƒè¦æ±‚

- Python 3.9+
- 40GB+ å­˜å‚¨ç©ºé—´
- 2GB+ å†…å­˜

### 2.2 å®‰è£…æ­¥éª¤

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd "Learning Archive Platform"

# 2. åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# Windows
venv\Scripts\activate

# Linux/macOS
source venv/bin/activate

# 3. å®‰è£…ä¾èµ–
cd backend
pip install -r requirements.txt

# 4. åˆå§‹åŒ–æ•°æ®åº“
python scripts/init_db.py

# 5. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶

# 6. å¯åŠ¨æœåŠ¡
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 2.3 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### ä½¿ç”¨Gunicorn + Uvicorn Workers

```bash
# å®‰è£…Gunicorn
pip install gunicorn

# å¯åŠ¨æœåŠ¡ï¼ˆå¤šworkerï¼‰
gunicorn app.main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000 \
  --access-logfile - \
  --error-logfile -
```

#### ä½¿ç”¨Nginxåå‘ä»£ç†

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # é™æ€æ–‡ä»¶
    location /static {
        alias /path/to/frontend/static;
    }
}
```

## 3. äº‘æœåŠ¡å™¨éƒ¨ç½²

### 3.1 ä½¿ç”¨systemdç®¡ç†æœåŠ¡

åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/learning-archive.service`:

```ini
[Unit]
Description=Learning Archive Platform
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/Learning Archive Platform/backend
Environment="PATH=/path/to/venv/bin"
ExecStart=/path/to/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡:

```bash
sudo systemctl daemon-reload
sudo systemctl enable learning-archive
sudo systemctl start learning-archive
sudo systemctl status learning-archive
```

### 3.2 ä½¿ç”¨Supervisor

åˆ›å»ºé…ç½®æ–‡ä»¶ `/etc/supervisor/conf.d/learning-archive.conf`:

```ini
[program:learning-archive]
command=/path/to/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
directory=/path/to/Learning Archive Platform/backend
user=www-data
autostart=true
autorestart=true
stderr_logfile=/var/log/learning-archive.err.log
stdout_logfile=/var/log/learning-archive.out.log
```

å¯åŠ¨æœåŠ¡:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start learning-archive
```

## 4. ç¯å¢ƒå˜é‡é…ç½®

åˆ›å»º `.env` æ–‡ä»¶:

```env
# åº”ç”¨é…ç½®
APP_NAME=å­¦ä¹ èµ„æ–™èšåˆå¹³å°
DEBUG=False
HOST=0.0.0.0
PORT=8000

# æ•°æ®åº“é…ç½®
DATABASE_URL=sqlite:///./data/archive.db

# å®‰å…¨é…ç½®
SECRET_KEY=your-secret-key-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# çˆ¬è™«é…ç½®
CRAWLER_USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
CRAWLER_REQUEST_DELAY=1.0
CRAWLER_MAX_RETRIES=3
```

## 5. æ•°æ®å¤‡ä»½

### 5.1 æ•°æ®åº“å¤‡ä»½

```bash
# SQLiteæ•°æ®åº“å¤‡ä»½
sqlite3 data/archive.db ".backup backup/archive_$(date +%Y%m%d).db"

# æˆ–ä½¿ç”¨Pythonè„šæœ¬
python scripts/backup_database.py
```

### 5.2 æ–‡ä»¶å¤‡ä»½

```bash
# å¤‡ä»½é‡‡é›†æ–‡ä»¶å’Œä¸Šä¼ æ–‡ä»¶
tar -czf backup/files_$(date +%Y%m%d).tar.gz data/collections data/uploads
```

### 5.3 è‡ªåŠ¨å¤‡ä»½è„šæœ¬

åˆ›å»º `scripts/backup.sh`:

```bash
#!/bin/bash
BACKUP_DIR="/path/to/backup"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
sqlite3 data/archive.db ".backup $BACKUP_DIR/db_$DATE.db"

# å¤‡ä»½æ–‡ä»¶
tar -czf $BACKUP_DIR/files_$DATE.tar.gz data/collections data/uploads

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.db" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
```

æ·»åŠ åˆ°crontab:

```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå¤‡ä»½
0 2 * * * /path/to/scripts/backup.sh
```

## 6. ç›‘æ§ä¸æ—¥å¿—

### 6.1 æ—¥å¿—ä½ç½®

- åº”ç”¨æ—¥å¿—: `logs/app_YYYYMMDD.log`
- é”™è¯¯æ—¥å¿—: `logs/error_YYYYMMDD.log`

### 6.2 å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:8000/health

# é¢„æœŸå“åº”
{"status": "ok"}
```

### 6.3 ç›‘æ§æŒ‡æ ‡

- APIå“åº”æ—¶é—´
- æ•°æ®åº“è¿æ¥æ•°
- æ–‡ä»¶å­˜å‚¨ä½¿ç”¨ç‡
- é‡‡é›†ä»»åŠ¡æˆåŠŸç‡

## 7. æ•…éšœæ’æŸ¥

### 7.1 å¸¸è§é—®é¢˜

**é—®é¢˜1: ç«¯å£è¢«å ç”¨**
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :8000
# æˆ–
netstat -tulpn | grep 8000

# æ€æ­»è¿›ç¨‹
kill -9 <PID>
```

**é—®é¢˜2: æ•°æ®åº“é”å®š**
```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
ls -l data/archive.db

# ä¿®å¤æƒé™
chmod 644 data/archive.db
```

**é—®é¢˜3: ä¾èµ–å®‰è£…å¤±è´¥**
```bash
# æ›´æ–°pip
pip install --upgrade pip

# ä½¿ç”¨å›½å†…é•œåƒæº
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 7.2 æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
tail -f logs/app_$(date +%Y%m%d).log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep ERROR logs/app_*.log

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´æ®µçš„æ—¥å¿—
grep "2025-01-18 10:" logs/app_20250118.log
```

## 8. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 8.1 æ•°æ®åº“ä¼˜åŒ–

- å®šæœŸæ‰§è¡Œ `VACUUM` ä¼˜åŒ–æ•°æ®åº“
- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
- å®šæœŸæ¸…ç†æ—§æ—¥å¿—æ•°æ®

### 8.2 åº”ç”¨ä¼˜åŒ–

- ä½¿ç”¨Gunicornå¤šworkeræ¨¡å¼
- é…ç½®Nginxç¼“å­˜é™æ€èµ„æº
- å¯ç”¨gzipå‹ç¼©

### 8.3 å­˜å‚¨ä¼˜åŒ–

- å®šæœŸæ¸…ç†æ—§ç‰ˆæœ¬æ–‡ä»¶
- ä½¿ç”¨å‹ç¼©å­˜å‚¨
- è€ƒè™‘ä½¿ç”¨å¯¹è±¡å­˜å‚¨ï¼ˆå¦‚S3ï¼‰

## 9. å®‰å…¨å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**
   - ä¿®æ”¹é»˜è®¤SECRET_KEY
   - è®¾ç½®DEBUG=False
   - é…ç½®HTTPS
   - é™åˆ¶CORSæ¥æº

2. **è®¿é—®æ§åˆ¶**
   - ä½¿ç”¨é˜²ç«å¢™é™åˆ¶ç«¯å£è®¿é—®
   - é…ç½®Nginxè®¿é—®é™åˆ¶
   - å®šæœŸæ›´æ–°ä¾èµ–åŒ…

3. **æ•°æ®å®‰å…¨**
   - å®šæœŸå¤‡ä»½æ•°æ®
   - åŠ å¯†æ•æ„Ÿé…ç½®
   - é™åˆ¶æ–‡ä»¶ä¸Šä¼ ç±»å‹å’Œå¤§å°

---

**æœ€åæ›´æ–°**: 2025-01-18
