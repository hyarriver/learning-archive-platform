# 在服务器上执行以下命令手动部署

# 1. 进入后端目录
cd /opt/Learning\ Archive\ Platform/backend

# 2. 删除旧的虚拟环境（如果存在）
rm -rf venv

# 3. 创建新的虚拟环境
python3 -m venv venv

# 4. 验证虚拟环境是否创建成功
ls -la venv/bin/activate

# 5. 激活虚拟环境
source venv/bin/activate

# 6. 升级 pip
pip install --upgrade pip

# 7. 安装依赖
pip install -r requirements.txt

# 8. 配置环境变量
cp .env.example .env

# 9. 生成随机密钥（执行两次，分别用作 SECRET_KEY 和 JWT_SECRET_KEY）
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# 10. 编辑 .env 文件
nano .env

# 在 .env 文件中修改：
# PORT=3000
# DEBUG=False
# APP_ENV=production
# SECRET_KEY=刚才生成的第一密钥
# JWT_SECRET_KEY=刚才生成的第二密钥

# 11. 初始化数据库
python scripts/init_db.py

# 12. 创建管理员用户（替换 your_password 为你的密码）
python scripts/create_user.py admin your_password

# 13. 测试运行
uvicorn app.main:app --host 0.0.0.0 --port 3000

# 如果测试成功，按 Ctrl+C 停止，然后继续

# 14. 创建 systemd 服务文件
sudo nano /etc/systemd/system/archive-platform.service

# 粘贴以下内容：
# [Unit]
# Description=Learning Archive Platform API
# After=network.target
#
# [Service]
# Type=simple
# User=root
# WorkingDirectory=/opt/Learning Archive Platform/backend
# Environment="PATH=/opt/Learning Archive Platform/backend/venv/bin"
# ExecStart=/opt/Learning Archive Platform/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 3000
# Restart=always
# RestartSec=10
# StandardOutput=journal
# StandardError=journal
#
# [Install]
# WantedBy=multi-user.target

# 15. 启用并启动服务
sudo systemctl daemon-reload
sudo systemctl enable archive-platform
sudo systemctl start archive-platform
sudo systemctl status archive-platform

# 16. 配置防火墙
sudo ufw allow 3000/tcp
sudo ufw reload

# 17. 验证部署
curl http://112.124.2.164:3000/health
