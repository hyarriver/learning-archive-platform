# 服务器部署配置说明

## 服务器信息
- **服务器地址**: 112.124.2.164
- **端口**: 3000

## 配置步骤

### 1. 后端配置

#### 修改 `backend/.env` 文件（或创建新文件）

```env
# 应用配置
APP_NAME=Learning Archive Platform
APP_ENV=production
DEBUG=False
SECRET_KEY=请生成一个随机的安全密钥

# 服务器配置
HOST=0.0.0.0
PORT=3000

# 数据库
DATABASE_URL=sqlite:///./data/archive.db

# JWT配置（生产环境必须使用强密钥）
JWT_SECRET_KEY=请生成一个随机的JWT密钥
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=1440

# 文件存储
DATA_DIR=./data
COLLECTIONS_DIR=./data/collections
UPLOADS_DIR=./data/uploads

# 任务调度
SCHEDULER_TIMEZONE=Asia/Shanghai
COLLECTION_SCHEDULE_HOUR=0
COLLECTION_SCHEDULE_MINUTE=0

# 爬虫配置
CRAWLER_USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
CRAWLER_REQUEST_DELAY=1.0
CRAWLER_MAX_RETRIES=3

# 日志
LOG_LEVEL=INFO
LOG_DIR=./logs
```

#### 生成安全密钥

```bash
# Python 中生成随机密钥
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

将生成的密钥分别填入 `SECRET_KEY` 和 `JWT_SECRET_KEY`

### 2. 前端配置

#### 方式一：修改前端 API 配置（推荐）

修改 `frontend/js/api.js` 文件：

```javascript
// 将这一行：
const API_BASE_URL = window.location.origin;

// 改为：
const API_BASE_URL = 'http://112.124.2.164:3000';
```

#### 方式二：使用 Nginx 反向代理（生产环境推荐）

如果使用 Nginx 反向代理，可以保持前端配置为相对路径，通过 Nginx 转发请求。

### 3. 服务器部署步骤

#### 3.1 上传项目文件

```bash
# 使用 scp 上传项目（示例）
scp -r "Learning Archive Platform" root@112.124.2.164:/opt/

# 或使用 git 在服务器上克隆
cd /opt
git clone <your-repo-url> "Learning Archive Platform"
```

#### 3.2 安装 Python 环境

```bash
# 登录服务器
ssh root@112.124.2.164

# 安装 Python 3.9+（如果未安装）
# Ubuntu/Debian:
apt update && apt install -y python3 python3-pip python3-venv

# CentOS/RHEL:
yum install -y python3 python3-pip
```

#### 3.3 设置项目

```bash
cd /opt/Learning\ Archive\ Platform/backend

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 安装系统依赖（如果需要）
# Ubuntu/Debian:
apt install -y pandoc  # 可选，用于更好的Markdown转换
```

#### 3.4 配置环境变量

```bash
# 创建 .env 文件
cp .env.example .env
nano .env  # 或使用其他编辑器

# 修改必要的配置（见步骤1）
```

#### 3.5 初始化数据库

```bash
# 确保虚拟环境已激活
source venv/bin/activate

# 初始化数据库
python scripts/init_db.py

# 创建管理员用户
python scripts/create_user.py admin your_secure_password
```

#### 3.6 启动服务

##### 方式一：直接运行（开发/测试）

```bash
cd /opt/Learning\ Archive\ Platform/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 3000
```

##### 方式二：使用 systemd 服务（生产环境推荐）

创建服务文件 `/etc/systemd/system/archive-platform.service`:

```ini
[Unit]
Description=Learning Archive Platform API
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/Learning Archive Platform/backend
Environment="PATH=/opt/Learning Archive Platform/backend/venv/bin"
ExecStart=/opt/Learning Archive Platform/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 3000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用并启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable archive-platform
sudo systemctl start archive-platform
sudo systemctl status archive-platform  # 查看状态
```

#### 3.7 配置 Nginx（可选但推荐）

创建 Nginx 配置 `/etc/nginx/sites-available/archive-platform`:

```nginx
server {
    listen 80;
    server_name 112.124.2.164;

    # API 代理
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 前端静态文件
    location / {
        root /opt/Learning Archive Platform/frontend;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # 静态资源
    location /static {
        root /opt/Learning Archive Platform/frontend;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/archive-platform /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl reload nginx
```

#### 3.8 配置防火墙

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 3000/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --reload
```

### 4. 前端部署

#### 方式一：使用 Nginx 服务静态文件（推荐）

前端文件已包含在项目中，Nginx 配置（见步骤3.7）已处理。

#### 方式二：直接访问 API

如果只想使用 API，前端可以部署到其他位置或本地使用。

### 5. 验证部署

1. **检查后端服务**
   ```bash
   curl http://112.124.2.164:3000/health
   ```

2. **访问 API 文档**
   ```
   http://112.124.2.164:3000/docs
   ```

3. **访问前端页面**
   ```
   http://112.124.2.164:3000/index.html
   ```
   或使用 Nginx:
   ```
   http://112.124.2.164
   ```

### 6. 安全建议

1. **启用 HTTPS**（强烈推荐）
   - 使用 Let's Encrypt 免费证书
   - 配置 Nginx SSL

2. **限制访问**
   - 配置防火墙规则
   - 使用 fail2ban 防止暴力破解

3. **定期备份**
   ```bash
   # 备份数据库和文件
   tar -czf backup-$(date +%Y%m%d).tar.gz /opt/Learning\ Archive\ Platform/data
   ```

4. **监控日志**
   ```bash
   # 查看应用日志
   tail -f /opt/Learning\ Archive\ Platform/backend/logs/app_*.log
   
   # 查看系统服务日志
   sudo journalctl -u archive-platform -f
   ```

### 7. 常见问题

#### 端口被占用
```bash
# 检查端口占用
sudo netstat -tulpn | grep 3000
# 或
sudo lsof -i :3000

# 修改 .env 中的 PORT 或停止占用端口的程序
```

#### 权限问题
```bash
# 确保目录权限正确
sudo chown -R www-data:www-data /opt/Learning\ Archive\ Platform/data
sudo chown -R www-data:www-data /opt/Learning\ Archive\ Platform/logs
```

#### 服务无法启动
```bash
# 查看详细错误信息
sudo journalctl -u archive-platform -n 50
# 或直接运行查看输出
cd /opt/Learning\ Archive\ Platform/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 3000
```

---

**部署完成后，请确保：**
- ✅ 后端服务正常运行在 3000 端口
- ✅ 前端可以访问并正确连接到后端 API
- ✅ 数据库已初始化并创建了管理员用户
- ✅ 定时任务调度器正常运行
- ✅ 防火墙规则已配置
- ✅ 安全密钥已修改
