# 继续部署步骤

你已经安装了 `python3.12-venv`，现在可以继续部署：

## 继续执行部署脚本

```bash
# 在服务器上执行
cd /opt/Learning\ Archive\ Platform
./快速部署脚本.sh
```

或者手动执行以下步骤：

## 手动部署步骤

### 1. 进入后端目录
```bash
cd /opt/Learning\ Archive\ Platform/backend
```

### 2. 创建虚拟环境
```bash
python3 -m venv venv
```

### 3. 激活虚拟环境并安装依赖
```bash
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

### 4. 配置环境变量
```bash
# 复制环境变量示例
cp .env.example .env

# 编辑配置
nano .env
```

**重要配置项**：
```env
# 服务器配置
PORT=3000
DEBUG=False
APP_ENV=production

# 生成随机密钥（在服务器上执行）
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

将生成的密钥填入：
- `SECRET_KEY=生成的密钥`
- `JWT_SECRET_KEY=生成的另一个密钥`

### 5. 初始化数据库
```bash
# 确保虚拟环境已激活
source venv/bin/activate

python scripts/init_db.py
```

### 6. 创建管理员用户
```bash
python scripts/create_user.py admin your_secure_password
```

### 7. 测试运行（验证配置）
```bash
uvicorn app.main:app --host 0.0.0.0 --port 3000
```

如果测试成功，按 `Ctrl+C` 停止，然后继续下一步。

### 8. 创建 systemd 服务

```bash
sudo nano /etc/systemd/system/archive-platform.service
```

复制以下内容：
```ini
[Unit]
Description=Learning Archive Platform API
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/Learning Archive Platform/backend
Environment="PATH=/opt/Learning Archive Platform/backend/venv/bin"
ExecStart=/opt/Learning Archive Platform/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 3000
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

保存并退出（Ctrl+O, Enter, Ctrl+X）

### 9. 启用并启动服务

```bash
sudo systemctl daemon-reload
sudo systemctl enable archive-platform
sudo systemctl start archive-platform
sudo systemctl status archive-platform
```

### 10. 配置防火墙

```bash
# Ubuntu/Debian
sudo ufw allow 3000/tcp
sudo ufw reload

# 或检查防火墙状态
sudo ufw status
```

### 11. 验证部署

```bash
# 检查服务状态
systemctl status archive-platform

# 查看日志
journalctl -u archive-platform -f

# 测试访问（在本地或其他机器）
curl http://112.124.2.164:3000/health
```

应该返回：
```json
{"status":"ok"}
```

## 访问地址

部署成功后，可以通过以下地址访问：

- **前端页面**: http://112.124.2.164:3000/
- **API 文档**: http://112.124.2.164:3000/docs
- **健康检查**: http://112.124.2.164:3000/health

## 常见问题

### 如果服务启动失败

```bash
# 查看详细错误
journalctl -u archive-platform -n 50

# 或直接运行查看输出
cd /opt/Learning\ Archive\ Platform/backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 3000
```

### 如果端口被占用

```bash
# 检查端口占用
sudo netstat -tulpn | grep 3000
# 或
sudo lsof -i :3000

# 修改 .env 中的 PORT 或停止占用端口的程序
```

### 如果无法访问

1. 检查服务是否运行：`systemctl status archive-platform`
2. 检查防火墙：`ufw status`
3. 检查端口是否开放：`netstat -tulpn | grep 3000`
4. 查看日志：`journalctl -u archive-platform -f`

## 服务管理命令

```bash
# 启动服务
sudo systemctl start archive-platform

# 停止服务
sudo systemctl stop archive-platform

# 重启服务
sudo systemctl restart archive-platform

# 查看状态
sudo systemctl status archive-platform

# 查看实时日志
sudo journalctl -u archive-platform -f

# 查看最近100行日志
sudo journalctl -u archive-platform -n 100
```

---

**现在可以继续执行部署步骤了！**
